# 结构插件移植

## 1，个人问题梳理

1，探索者软件是否不是必须的 因为前面那两个已经是完整的插件了  只是用于一键继承的壳子



2，探索者和autocad的版本



3，具体的功能实用   







## 2，插件功能整理

### 一、整体定位

这两个文件夹共同组成了“结构工具条”插件的核心内容，用于在 AutoCAD 中实现结构图相关的绘图、标注、构件布置等功能。

------

### 二、组成与分工



| 文件夹      | 主要内容                                        | 功能定位                                                     |
| ----------- | ----------------------------------------------- | ------------------------------------------------------------ |
| `jys2-2014` | 大量 `.lsp` 脚本（如 `ELVT.LSP`, `ANCHOR.LSP`） | 🔧 **功能实现层**：包含所有命令的核心逻辑脚本，是插件的执行部分 |
| `tssd2007`  | `.mns` 菜单文件、`.bmp` 图标、`Acad.lsp` 加载器 | 🎛️ **界面与加载层**：负责定义按钮界面、图标绑定与插件自动加载入口 |

------

### 三、加载与调用关系

AutoCAD 启动
   ↓
加载 Acad.lsp（插件入口）
   ↓
加载菜单 TssdUser.mns → 显示工具条按钮
   ↓
用户点击按钮 → 触发菜单中绑定命令（如 ELVT）
   ↓
ELVT 命令在 jys2 的 ELVT.LSP 中实现 → 实际执行功能



------

### 四、各组件具体作用

#### ✅ `jys2-2014`

- `.lsp` 文件：每个文件对应一个命令，如 `ELVT`, `ANCHOR`, `CHTEXT`
- 提供所有功能的逻辑定义，可在中望CAD中独立加载运行

#### ✅ `tssd2007`

- `TssdUser.mns`：定义菜单结构与按钮命令绑定
- `.bmp` 图标：提供按钮的图形外观
- `Acad.lsp`：启动时统一加载 `.lsp` 脚本并导入菜单界面



### 总结一句话

> `tssd2007` 管“界面和入口”，`jys2-2014` 管“命令和功能”，结构工具条插件通过 `Acad.lsp` 把菜单（.mns）和脚本（.lsp）联合起来，形成完整功能。





## 3，Acad.lisp

```lisp
;;; 以下几项是在注册表中进行存储，用于设置 AutoCAD 的工作环境
(setvar "FileDia" 1)      ; 显示文件对话框（如打开/保存）
(setvar "CmdDia" 1)       ; 显示打印、外部命令的对话框
(setvar "MenuCtl" 0)      ; 菜单控制设置为键盘输入优先

;;; 以下几项也保存在注册表中，用于设置绘图行为
(setvar "MirrText" 0)     ; 镜像文字时不翻转（保持可读）
(setvar "LimCheck" 0)     ; 允许在图形界限外绘图
(setvar "AttMode" 1)      ; 所有属性都显示
(setvar "AttDia" 0)       ; 属性编辑使用命令行模式，不弹出对话框
(setvar "PickStyle" 0)    ; 禁用组选择和关联填充选择

;; 以下为启动函数（注释掉了），可能原本用于菜单加载和初始化提示
;; 如果你打开 AutoCAD 的时候，这个插件没加载菜单，就自动帮你加载它的菜单文件，
;; 并执行一些初始化设置，还在下面状态栏上显示“jys Version 1.0”，并且在命令行里提示“结构jys v2.0
;; (defun s::startup ()
;;   (if (not (menugroup "jys")) (command "menu" "jys.mnu" "prnsc"))
;;   (command "spsinit")
;;   (princ "\n≡ 结构jys v2.0 ≡")
;;   (setvar "modemacro" "jys Version 1.0")
;;   (princ)
;; )

;;; ========== 工具函数 ==========

(defun disxy (pt x y)
  ;; 将点 pt 按 x, y 平移后的新坐标
  (list (+ (car pt) x) (+ (cadr pt) y)))

(defun tg (x)
  ;; 计算 tan(x)
  (/ (sin x) (cos x)))

;;; ========== 全局变量初始化 ==========
(setq dr-nm nil comctr '(0) drnumb 0 ar-tab nil)
(setq crnumb nil drpt1 nil drpt2 nil scl-1 nil scl-2 nil axiscale 1.0)
(setq comnrd nil drtype nil arname nil fdt nil unidis 100)

;;; ========== 清除对象捕捉设置命令 ==========
(defun c:clean ()
  (setvar "osmode" 0) ; 关闭所有对象捕捉
  (setq atomlist (member 'C:CLEAN atomlist)) ; 检查命令是否存在于命令列表
  'OK! ; 返回 OK
)

;;; ========== 从用户变量读取比例参数 ==========
(setq axiscale (getvar "userr1")) ; 获取用户变量1（主比例） 控制绘图的主缩放倍数（比如：1cm画成2cm）
(setq scl-2 (getvar "userr2"))     ; 获取用户变量2（副比例）  控制某些功能里的微调缩放，精细控制尺寸

(if (= scl-2 0) (setq scl-2 10.0)) ; 如果 scl-2 未设置，默认设为 10
(setq scl-2 (/ 1.0 scl-2))         ; scl-2 取倒数

(if (= axiscale 0) (setq axiscale 2.0)) ; 默认主比例为 2.0

(load "d:/jys2-2014/tszsc.fas") ; 加载外部功能模块

;;; ========== 读取文件中以某关键词s1开头的行 ==========
(defun rddatf (s1 file / f1 ctr)
  (setq f1 (open file "r") tab (read-line f1) ctr 1)
  (while (and tab ctr)
    (setq tab (read tab))
    (if (= s1 (car tab)) (setq ctr nil) (setq tab (read-line f1)))
  )
  (close f1) tab ; 返回匹配的行内容
)

;;; 点平移函数（简写版）
(defun dxy (pt1 xx yy)
  (setq pt1 (list (+ (car pt1) xx) (+ (cadr pt1) yy)))
)

;;; 获取当前图层
(defun getla (/) (setq la (getvar "clayer")))

;;; 设置当前图层
(defun setla (lla) (command "layer" "s" lla ""))

;;; ========== 加载更改宽度模块命令 ==========
(defun c:cw (/ object num width obj1 name cenpoint diam)
  (load "D:/jys2-2014/chwidth")
)

;;; ========== 复制选择对象命令 ==========
;; 你输入 c，就能框选 CAD 图元并复制
(defun c:c (/ s)
  (setq s (ssget)) ; 获取用户选择
  (if s (command "copy" s "" "m" pause)) ; 执行复制命令
  (princ)
)

;;; ========== 加载其他外部命令 ==========
;; 按需加载外部功能模块
(defun c:bb () (load "D:/jys2-2014/break.lsp"))
(defun c:1 ()  (load "D:/jys2-2014/rof.lsp"))
(defun c:5 ()  (load "D:/jys2-2014/TXTH.lsp"))
(defun c:oo () (load "D:/jys2-2014/roff"))
(defun c:hh () (load "D:/jys2-2014/autoelev"))

;;; 设置对象捕捉模式为 679（组合模式）
(defun c:aa ()
  (setvar "osmode" 679)
)

;;; 图层属性更改函数（颜色、图层、线型）
(defun chp (c la lt / s)
  (setvar "cmdecho" 0) ; 关闭命令回显
  (setq s (ssget))     ; 获取选择集
  (if s
    (command "change" s "" "p" "c" c "la" la "lt" lt "")
  )
  (setvar "cmdecho" 1)
  (princ)
)

;;; 快捷设置图层属性命令（0~8图层）
;;; 调用上一个函数  一键归类图形到不同编号的图层，方便统一管理和打印样式控制
(defun c:00 () (chp "bylayer" "0"  "bylayer"))
(defun c:11 () (chp "bylayer" "01" "bylayer"))
(defun c:22 () (chp "bylayer" "02" "bylayer"))
(defun c:33 () (chp "bylayer" "03" "bylayer"))
(defun c:44 () (chp "bylayer" "04" "bylayer"))
(defun c:55 () (chp "bylayer" "05" "bylayer"))
(defun c:66 () (chp "bylayer" "06" "bylayer"))
(defun c:77 () (chp "bylayer" "07" "bylayer"))
(defun c:88 () (chp "bylayer" "08" "bylayer"))

;;; ========== 字体样式设置函数 ==========
(defun mstyle (stname sthigh stwidth)
  ;; 传入字体名、文字高、宽度比，设置对应样式
  (progn
    (cond
      ((= (strcase stname) "SIMPLEX") (command "style" "simplex" "simplex,hztxt" sthigh stwidth "" "" "" ""))
      ((= (strcase stname) "COMPLEX") (command "style" "complex" "txt,hztxt" sthigh stwidth "" "" "" ""))
      ((= (strcase stname) "ROMAND")  (command "style" "romand"  "simplex,hztxt" sthigh stwidth "" "" "" ""))
      ((= (strcase stname) "GREEKC")  (command "style" "greekc"  "txt,hztxt" sthigh stwidth "" "" "" ""))
      ((= (strcase stname) "STANDARD")(command "style" "standard" "txt,hztxt" sthigh stwidth "" "" "" ""))
      ((= (strcase stname) "HZ_ST")   (command "style" "hz_st"   "txt,hztxt" sthigh stwidth "" "" "" ""))
    )
    (setq sthigh nil) ; 清空高设置
  )
)

```



## ✅ `acad.lsp` 中使用的 `setvar` / `getvar` 变量说明表（Markdown 格式）

| 变量名    | 类型   | 使用方式                               | 说明                                            |
| --------- | ------ | -------------------------------------- | ----------------------------------------------- |
| FileDia   | setvar | (setvar "FileDia" 1)                   | 是否显示“打开/保存文件”对话框，1=显示，0=命令行 |
| CmdDia    | setvar | (setvar "CmdDia" 1)                    | 是否显示“打印等命令”对话框，1=弹窗，0=命令行    |
| MenuCtl   | setvar | (setvar "MenuCtl" 0)                   | 控制屏幕菜单是否响应命令，0=不响应              |
| MirrText  | setvar | (setvar "MirrText" 0)                  | 镜像文字时是否翻转，0=保持方向不变              |
| LimCheck  | setvar | (setvar "LimCheck" 0)                  | 是否限制在图形界限内作图，0=不限                |
| AttMode   | setvar | (setvar "AttMode" 1)                   | 属性是否显示，1=全部属性可见                    |
| AttDia    | setvar | (setvar "AttDia" 0)                    | 是否使用属性对话框，0=命令行输入                |
| PickStyle | setvar | (setvar "PickStyle" 0)                 | 是否启用编组选择，0=禁用组选择                  |
| OsMode    | setvar | (setvar "OsMode" 0 / 679)              | 对象捕捉模式，0=关闭，679=开启多种吸附点        |
| Cmdecho   | setvar | (setvar "Cmdecho" 0 / 1)               | 是否显示命令执行过程，0=不显示                  |
| Modemacro | setvar | (setvar "Modemacro" "jys Version 1.0") | 设置状态栏文字（本例中被注释掉）                |
| Userr1    | getvar | (getvar "Userr1")                      | 读取主比例系数，插件自定义用途                  |
| Userr2    | getvar | (getvar "Userr2")                      | 读取副比例系数，用作比例倒数                    |
| Clayer    | getvar | (getvar "Clayer")                      | 获取当前图层名（用于图层切换）                  |

## ✅ 命令行可用的用户命令（`(defun c:xxx)`）

| 命令名  | 命令输入 | 功能说明                                         |
| ------- | -------- | ------------------------------------------------ |
| `clean` | `clean`  | 清除对象捕捉设置（关闭所有吸附点）               |
| `cw`    | `cw`     | 加载 chwidth.lsp 模块（更改线宽）                |
| `c`     | `c`      | 执行复制操作（用户选择 → 复制）                  |
| `bb`    | `bb`     | 加载 break.lsp 模块（断线命令）                  |
| `1`     | `1`      | 加载 rof.lsp 模块（功能未知）                    |
| `5`     | `5`      | 加载 TXTH.lsp 模块（文字处理）                   |
| `oo`    | `oo`     | 加载 roff 模块（功能未知）                       |
| `hh`    | `hh`     | 加载 autoelev 模块（自动标高）                   |
| `aa`    | `aa`     | 设置对象捕捉模式为 679（端点、中点、交点等启用） |
| `00`    | `00`     | 设置图层为 "0"，颜色线型随图层                   |
| `11`    | `11`     | 设置图层为 "01"，颜色线型随图层                  |
| `22`    | `22`     | 设置图层为 "02"，颜色线型随图层                  |
| `33`    | `33`     | 设置图层为 "03"，颜色线型随图层                  |
| `44`    | `44`     | 设置图层为 "04"，颜色线型随图层                  |
| `55`    | `55`     | 设置图层为 "05"，颜色线型随图层                  |
| `66`    | `66`     | 设置图层为 "06"，颜色线型随图层                  |
| `77`    | `77`     | 设置图层为 "07"，颜色线型随图层                  |
| `88`    | `88`     | 设置图层为 "08"，颜色线型随图层                  |

------

## 🔧 内部工具函数（`(defun xxx)`，仅供代码内部调用）

| 函数名   | 功能说明                                 |
| -------- | ---------------------------------------- |
| `disxy`  | 返回一个点沿 X、Y 偏移后的新坐标         |
| `tg`     | 返回 tan(x)（即 sin(x)/cos(x)）          |
| `dxy`    | 对点对象进行平移，结果直接写回（副作用） |
| `rddatf` | 从指定文件中读取“首列匹配某值”的行并返回 |
| `getla`  | 获取当前图层名称                         |
| `setla`  | 设置当前工作图层为指定图层名             |
| `chp`    | 修改选中对象的颜色、图层、线型           |
| `mstyle` | 设置当前文字样式（字体名、高度、宽度）   |





## 4，支持迁移的代码

常用工具条的最后两个

以及符号工具条理带有jys文件夹的部分



一部分是我们自己开发的 `.lsp` 脚本（在 `jys2-2014` 下），这部分我**完全可以迁移到中望CAD**。

另一部分是“探索者”工具栏对应的功能，这些功能是**探索者软件公司封装的商业模块**，我**无法访问其源码**，也**无法迁移适配中望CAD**。 除非探索者官方发布支持中望CAD的版本（ZRX插件），否则这部分功能我**确实做不到迁移**。





# lsp脚本功能汇总

## 1，常用工具条

ID_E__HXW_LSP_TABT2_0 [_Button("常用表格", "RCDA9358.BMP", "RCDATA_16_SAVE")]^C^C(LOAD"D:/JYS2/TAB/TABT2") 
               [--]
ID_E__HXW_LSP_MEM_0 [_Button("数据处理", "RCDA6962.BMP", "RCDATA_16_ETRANSMIT")]^C^C(LOAD"d:/jys2/tab/MEM") 



### 1 D:/JYS2/TAB/TABT2---常用表格

#### 📌 功能概述

- 显示表格缩略图（`tabt2.sld`）
- 用户点击选择表格样式（3×3栅格）
- 插入对应的表格块（`btt11.dwg` 等）
- 特殊样式（如 `11`）支持动态绘线（按行数）

#### 📁 依赖文件

| 类型     | 说明                                          |
| -------- | --------------------------------------------- |
| `.sld`   | `tabt2.sld`，滑图缩略图展示                   |
| `.dwg`   | `btt11.dwg` 等图块，按选择插入                |
| 图层     | 使用图层 `01` 和 `06` 区分主线与辅助线        |
| 工具函数 | `dxy`、`getla`、`setla`，必须在其他地方先定义 |

#### 🔧 迁移到中望CAD需修改

| 问题               | 替代方案                            |
| ------------------ | ----------------------------------- |
| `vslide` 不支持    | 改为用按钮/命令提示替代选择界面     |
| 图块路径硬编码     | 通过配置文件或对话框设定路径        |
| `command` 控制绘图 | 保留，ZWCAD 支持相同 `command` 用法 |

### 2 d:/jys2/tab/MEM---数据处理

#### 🧩 功能概述

该函数是一个`图形化的构件选择器，`主要功能为：

- 在 CAD 视图中加载一个 `.sld` 滑图（缩略图界面）
- 用户点击缩略图中的某一区域
- 程序识别点击位置并计算“区域编号”
- 根据编号加载对应的绘图功能脚本（如 `mater0.lsp`, `total.lsp` 等）

类似于一个“功能入口菜单”或“图形选单界面”。

------

#### 📁 外部依赖文件

| 类型     | 路径示例                      | 说明               |
| -------- | ----------------------------- | ------------------ |
| 滑图文件 | `D:/JYS2/TAB/mem.sld`         | 用于图形化选择界面 |
| LISP脚本 | `D:/JYS2/TAB/mater0.lsp` 等   | 各构件绘图脚本     |
| 其他脚本 | `total.lsp`, `textadd.lsp` 等 | 一些功能型绘图模块 |

------

#### 🔁 若迁移至中望CAD需要注意事项

| 项目                   | 建议处理说明                                                 |
| ---------------------- | ------------------------------------------------------------ |
| `.sld` 滑图文件        | 中望CAD 不完全兼容 AutoCAD `.sld`，建议用按钮或下拉菜单代替图形选择 |
| `(command "vslide"...` | 替换为图形界面函数或取消，使用命令行输入选择或自定义 GUI     |
| `(load "...")` 路径    | 改为相对路径或在用户第一次使用时选择 JYS 文件夹路径，保存为配置 |
| 文件路径写死问题       | 推荐使用 `(getenv)` 或配置文件存路径，避免 `D:/JYS2/...` 这种硬编码 |

------

#### ✅ 建议迁移策略

- 移除对 `vslide` 和 `.sld` 的依赖
- 用文字或按钮代替图形点击区域选择
- 对应 `joty` 区域编号逻辑仍可复用，用菜单选择代替图形点选
- 所有 `(load "...")` 的脚本必须保证存在并经过兼容性测试







| **编号** | **LISP 文件路径**       | **功能描述**                                                 | **依赖的外部文件**                        |
| -------- | ----------------------- | ------------------------------------------------------------ | ----------------------------------------- |
| 30       | D:/JYS2/TAB/mater0.lsp  | **`批量读取`**图纸表格中的编号、截面、长度、数量等信息，计算总重量并重新标注在图纸上 | (setq tab (rddatf sec "/hxw/lsp/xg.dat")) |
| 31       | D:/JYS2/TAB/mater1.lsp  | **`手动输入`**构件编号、截面、长度与数量，计算重量并标注图纸表格 | 同样 xg.dat                               |
| 32       | D:/JYS2/TAB/mater2.lsp  | 批量读取构件信息，按材料编号分类汇总总长与总重，并写入文件   | 用户输入的 .dat 文件                      |
| 33       | D:/JYS2/TAB/mater3.lsp  | 合并**`两个`**材料清单 `.dat` 文件内容，生成新的总清单文件并写入磁盘 | 用户指定的多个 `.dat` 文件                |
| 34       | D:/JYS2/TAB/mater4.lsp  | 对 `.dat` 材料清单排序与格式化，并生成带表头的 `.cll` 清单文件 | xg.dat、输入的 `.dat` 文件                |
| 20       | D:/JYS2/TAB/total.lsp   | 把选中的所有文字中的数字相加，并将总和标注在指定位置         | 无                                        |
| 21       | D:/JYS2/TAB/mult.lsp    | 将选中所有文字中的数字**乘以**输入的倍数，并直接修改原文字内容 | 无                                        |
| 22       | D:/JYS2/TAB/plus.lsp    | 将选中所有文字中的数字**加上**输入的数值，并直接修改原文字内容（整数） | 无                                        |
| 23       | D:/JYS2/TAB/challt.lsp  | 批量替换选中图中文字内容，可按指定内容匹配或全部替换         | 无                                        |
| 24       | D:/JYS2/TAB/int.lsp     | 将选中图中文字中的小数转为整数（**去掉小数点**）并替换原文字内容 | 无                                        |
| 25       | D:/JYS2/TAB/textadd.lsp | 将输入内容追加到选中文字对象的末尾，实现批量尾部加文字功能   | 无                                        |
| 10       | D:/JYS2/TAB/clline.lsp  | 手动绘制折线段，并在**`每段终点插入构件编号和信息的块参照`** | 块文件 /hxw/dwg/num                       |
| 11       | D:/JYS2/TAB/clnum.lsp   | 和上面一样 但是这里是**`鼠标点击选择线段`**  而不是自己选点划线 | 图块 D:/JYS2/num                          |
| 12       | D:/JYS2/TAB/mater2.lsp  | 批量读取构件信息，按材料编号分类汇总总长与总重，并写入文件   |                                           |
| 13       | D:/JYS2/TAB/datatj.lsp  | 统计你选中的所有文字里，每一类文字出现了几次，然后把统计结果保存到一个文本文件里 | 无                                        |



### 3，符号工具条

| 序号 | 按钮名称     | 加载的 LISP 文件路径     | 功能描述                                                     | 依赖的外部代码                                               |
| ---- | ------------ | ------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1    | 立面标高     | D:/jys2-2014/ELVTA.lsp   | 在剖面图中点击线段自动计算并标注**`立面标高`**值，含引线、斜线和标高文字 | 使用 `tszsc` 全局变量，依赖文字样式 TSSD_Rein                |
| 2    | 平面标高     | D:/jys2-2014/ELVTX.lsp   | 在平面图中点击点位自动绘制标高引线和文字，标注如 ±0.000、+3.300 等平面高程 | 依赖 tszsc 变量和字体 TSSD_Rein                              |
| 3    | 本图节点     | D:/jys2-2014/JD1.lsp     | 在图中点击位置，插入一个圆圈加编号的节点符号，仅用于图纸提示 | 依赖 tszsc 变量和文字样式 TSSD_Rein                          |
| 4    | 详图节点     | D:/jys2-2014/JD2.lsp     | 在图上画一个圆圈，圆圈上下可以写两行字，用来提醒“这个地方的细节画在别的图里”。 | 依赖 tszsc 变量和文字样式 TSSD_Rein                          |
| 5    | 索引节点     | D:/jys2-2014/JD3.lsp     | 在图中画线并画一个圆圈，圈上下写字，表示“这个位置和另一张图有关 | 依赖 tszsc 变量、文字样式 TSSD_Rein，加载 `bsf.lsp`（这里就一个dtr  转弧度的） |
| 6    | 改变线宽     | D:/jys2-2014/CHWIDTH.lsp | 输入一个宽度，批量修改线段、圆和折线的宽度，圆用甜甜圈替代模拟宽边效果 | 依赖 tszsc 变量，用于缩放                                    |
| 7    | 切角         | D:/jys2-2014/QJ.lsp      | 在角落点上画一条短线表示“切角”，用于表示局部剖掉或转角裁剪的提示符号 | 依赖 tszsc 变量，使用 dxy 函数                               |
| 8    | 横剖切       | D:/jys2-2014/PM3.lsp     | 在图中点两点画出一条剖切符号线，并自动添加剖面编号文字，用来表示“从这里剖开，详图在其他图纸中 | 依赖 tszsc 变量，文字样式 TSSD_Rein                          |
| 9    | 竖剖切       | D:/jys2-2014/PM4.lsp     | 点两点画出上下箭头线和剖面编号文字，表示“从此竖向剖开，详图见其他图纸” | tszsc 变量，文字样式 TSSD_Rein                               |
| 10   | 剖面号       | D:/jys2-2014/PMFH.lsp    | **`不画剖面线`**，只是在已有剖面线上插入剖面线两端编号，如“A-A”，常与横剖或竖剖搭配使用 | tszsc 变量，TSSD_Rein 文字样式                               |
| 11   | 零件号       | D:/jys2-2014/NUM1.lsp    | 点出一条折线路径后，在终点处画一个编号圆圈，并输入零件编号，如 Z12、B01 等。用于构件编号 | tszsc 变量，TSSD_Rein 文字样式                               |
| 12   | 轴线号       | D:/jys2-2014/AXISA.lsp   | 在你点选的直线（轴线）**末端自动偏移插入圆圈 + 编号**，用于表示轴线代号（如 A、1、B）。 | tszsc 变量，TSSD_Rein 文字样式                               |
| 13   | 带方向轴线号 | D:/jys2-2014/AXISJ.lsp   | 在轴线两端插入圆圈，中心写轴线编号，另一端加带箭头标记方向。用于表达轴线起止方向 | tszsc 变量、TSSD_Rein 字体样式                               |
| 14   | 两点构件     | D:/jys2-2014/MEMBER2.lsp | 用户依次点击两点，自动在两点之间**缩进固定距离**后画一条带宽度的线段（如钢梁）。缩进长度默认150mm，通过比例换算后作用于图纸中，常用于表示构件不封顶或留边。 | `tszsc` 全局比例变量                                         |
| 15   | 设备基础螺栓 | D:/jys2-2014/ANCHOR1.lsp | 通过加载一个**幻灯片图例界面（`vslide`）**，你点击不同的小图位置，程序会根据你的**点击坐标**计算出一个编号 `joty`，然后在插入点用代码画出该编号对应的螺栓图形（圆、弧、pline 等组成的图案）——**所有图形都是现画的，不依赖外部块文件**。 | tszsc 全局变量、vslide 图示幻灯片                            |
| 16   | 统一字体     | D:/JYS2/zcm.lsp          | 遍历当前图纸中的所有文字样式（单行和多行文字），将其字体替换为指定的标准字体（如仿宋、tssdeng），统一图纸排版。支持清除大括号与无效字体信息，自动调用 `-style` 命令批量替换 | 无外部依赖；通过 AutoLISP 内部处理文本样式                   |
| 17   | 圆剖切面     | D:/jys2-2014/QMX.lsp     | 选择两点，在其中间自动绘制交叉圆弧剖切标志                   | 无外部依赖                                                   |
| 18   | 加箭头       | D:/jys2-2014/JT.lsp      | 给选中的线一端添加箭头（三角形填充）                         | 依赖 `tszsc` 全局变量（比例）                                |
| 19   | 引出斜线     | D:/jys2-2014/TT.lsp      | 点击图中某个点后自动生成一条**固定角度粗斜线**，用于视觉强调或引出说明 | 依赖 `tszsc` 全局变量（比例）                                |
| 20   | 文字统一修改 | D:/jys2-2014/CHTEXT.lsp  | 批量选中文字对象，并逐个提示用户输入新文字进行修改           | 无                                                           |



#### **1，tszsx全局变量可能在启动时的其他lisp脚本中**



#### **2，**加载 `bsf.lsp`（这里就一个dtr  转弧度的）

这里面就一个将角度变成弧度的函数 直接打开或者让gpt补全都可以的

#### **3，横剖切/竖剖切/剖面号**

| 项目         | 横剖切（PM3）                                   | 竖剖切（PM4）                                     | 剖面号（PMFH）                                           |
| ------------ | ----------------------------------------------- | ------------------------------------------------- | -------------------------------------------------------- |
| 剖切方向     | 水平方向（左右）                                | 垂直方向（上下）                                  | 不涉及剖切，仅用于编号                                   |
| 图纸用途     | 从正面看结构，常用于生成 **剖面图、正视图**     | 从侧面或竖向看结构，常用于生成 **纵剖图、局部图** | 用于配合已有剖面线，插入标识编号（如 A-A）               |
| 偏移方向     | 沿 **Y 轴上下偏移**，极角 ±90°（`π/2`）         | 沿 **X 轴左右偏移**，极角 0 或 π（`0/π`）         | 无剖切线，不偏移，仅插在选中点位置                       |
| 插入文字位置 | 偏向上下位置（文字在剖线上方）                  | 偏向左右位置（文字在剖线两端）                    | 插在一个中心点，编号居中                                 |
| 剖线方向计算 | 动态计算两点夹角（`angle p1 p2`），决定箭头方向 | 判断 `p2.y` 和 `p1.y` 大小，决定箭头朝上或朝下    | 无剖线逻辑，仅生成文字+辅助线                            |
| 文字旋转角度 | 根据角度自动旋转（有时旋转 180°）               | 常为固定角度（一般不旋转）                        | 固定方向（默认水平）                                     |
| 实现灵活性   | 更灵活，可适应任意方向                          | 更傻瓜，仅支持竖向上下                            | 更简洁，仅用于标注编号，不绘图                           |
| 适合对象     | 墙体、梁、楼板横向剖切查看内部结构              | 柱子、门、楼梯等构件竖向剖切查看高度结构          | 任意剖切线的两端补充编号标注用，适合后补、手工编号等情况 |

#### **4，🧾轴线号/带方向轴线号**

| 项目           | 轴线号（AXISA）                    | 带方向轴线号（AXISJ）                            |
| -------------- | ---------------------------------- | ------------------------------------------------ |
| 插入效果       | 只在你点击的那一端添加一个编号圆圈 | 在轴线两端各插入一个圆圈：一端编号，一端方向箭头 |
| 是否有箭头     | ❌ 无箭头，只编号                   | ✅ 有箭头，标识轴线方向                           |
| 输入的编号数量 | 一个编号                           | 两个编号（中心编号 + 边编号）                    |
| 用户操作       | 选择轴线 + 输入编号                | 选择轴线 → 再点方向 → 输入两个编号               |
| 插入图元       | circle + text                      | circle + text + line + solid（箭头）             |
| 判断方向依据   | 距离判断靠近哪一端                 | 点选第二个“方向点”来判断朝哪边插入箭头           |
| 典型应用       | 普通轴线编号                       | 编号 + 指示方向（如轴线从 A 指向 C）             |



# 结构图纸学习  5.19-5.25

### 1，图纸解密

云平台网址：

[中冶南方BIM云平台](https://3d.wisdri.com/#/Home)



共享文件夹网址：

\\192.168.145.200\home\140881eefbfbdefbfbdefbfbdefbfbd4eefbfbdefbfbd1b74efbfbd3629efbfbd



拖到云平台上 然后从这个复制出来





### 2.插件入手



修改的文件有问题 我应该去修改d盘下面那个 傻逼了





梳理一下当前问题 问题有点多



#### 1，sld滑图无法使用的问题  (已经解决)

目前ahchor1.lsp的滑图是可以用的   说明可以先改这个让滑图可以用



#### 2， acad.lsp加载问题  （可以不解决）

每次都必须手动加载acad.lsp吗   可以不加载吗  

在prg里面的acaddoc里面加一句 在搜索路径里加载就可以 

但是这里我改名了 为了搜索到



#### 3，路径问题（已经解决）

菜单文件里很多都写死了d盘  这个尝试改一改



5.21  入口地址

D:\cad_project\tssdAutocad2007\tssd2007  改这里的

tssdUser   acad.lsp





现在进度：

acad.lsp加上路径获取文件了

tssduser也修改了所有绝对路径

两个复杂的sld流图路径已完成修改



这里修改的方式有些绕 是通过在文件中添加一个market.txt作为标识符 来获取到路径的

直接获取不知道为啥就是不行



这里 **tszsc是绘图比例  并且在探索者里修改就能反应到变量中**

**证明已经成功**

```
命令: (type tszsc)
SUBR

命令: (tszsc)
(50 50 T)
```





5.23

无法使用的功能：

最长的那一栏：就一个

统一字体：图标是个统



下面两个滑图：









字体问题：

hztxt.shx  在D:\cad_project\tssdAutocad2007\TSDP2021\Prg

`必须加载了acad才可以用滑图功能`





当前进度：

##### **（1）螺栓构件（已经解决）**

**已经可以全部加载**



##### **（2）字体功能zcm.lisp（已经解决）*  

下面是可以运行的zcm代码

```lisp
;;;-------------------------------------------------------------------------
;;;   TY_SMCAD.LSP 
;;;   Copyright (C) 2010.03.01
;;;   此程序用于修改汉字显现为"?"的问题.
;;;-------------------------------------------------------------------------

;;;   定义删除大括号的函数
(defun del_DKH(s)
  (setq n1 (strlen s) s9 "" sDKH "" n2 1)
  (repeat n1
    (setq sDKH (substr s n2 1))
    (if (or (= sDKH "{") (= sDKH "}")) (setq sDKH ""))
    (setq s9 (strcat s9 sDKH) n2 (1+ n2))
  ) ;repeat
  (setq s s9)
) ;defun

;;;   定义删除特殊字型设置的函数
(defun del_GGf(s)
  (setq n1 (strlen s) s9 "" sGGF "" sFH "" n2 1)
  (while (< n2 n1)
    (setq sGGF (substr s n2 2) sFH "")
    (if (= sGGF "\\f")
      (progn
        (setq n2 (+ n2 2))
        (while (and (< n2 n1) (/= sFH ";"))
          (setq sFH (substr s n2 1))
          (setq n2 (1+ n2))
        ) ;while
      ) ;progn
      (setq s9 (strcat s9 (substr sGGF 1 1)) n2 (1+ n2))
    ) ;if
  ) ;while
  (setq s s9)
) ;defun

;;;   定义替换字型的函数
(defun rep_GGf(s)
  (setq n1 (strlen s) s9 "" sGGF "" sFH "" n2 1)
  (while (< n2 n1)
    (setq sGGF (substr s n2 2) sFH "")
    (if (= sGGF "\\f")
      (progn
        (setq n2 (+ n2 2))
        (while (and (< n2 n1) (/= sFH "|"))
          (setq sFH (substr s n2 1))
          (setq n2 (1+ n2))
        ) ;while
      (setq s9 (strcat s9 "\\ftssdeng.shx,hztxt.shx|"))
      ) ;progn
      (setq s9 (strcat s9 (substr sGGF 1 1)) n2 (1+ n2))
    ) ;if
  ) ;while
  (setq s (strcat s9 (substr s n2)))
) ;defun

;;;   定义修改字表的函数
(defun rep_STY (s2)
  (if (and s2 (/= s2 "") (/= (strcase s2) "STANDARD"))
    (progn
      (princ (strcat "\n正在处理样式: " s2))
      (cond
        ((= s2 "CO3")
         (command "-style" s2 "hztxt.shx" "" 0.85 "" "N" "N" "N"))
        ((= s2 "SMCAD-BTL")
         (command "-style" s2 "hztxt.shx" "" 0.85 "" "N" "N" "N"))
        (T
         (command "-style" s2 "tssdeng.shx,hztxt.shx" "" 0.7 "" "N" "N" "N"))
      )
    )
    (princ (strcat "\n>> 跳过样式: " s2))
  )
)



;;;-------------------------------------------------------------------------

(princ "\nSMCAD-LSP, 修改(统一)文字的字体 ...")

;;;-------------------------------------------------------------------------
;;;;   修改单行文字
;;;-------------------------------------------------------------------------

(setq sn (tblnext "Style" T))
(setq sn (cdr (assoc '2 sn)))
(setq snn sn) 
(while (or (and sn (/= sn "")) (and snn (/= snn ""))) 
  (if (and sn (/= sn "")) (rep_STY sn)) 
  (setq snn sn) 
  (setq sn (tblnext "Style"))
  (setq sn (cdr (assoc '2 sn)))
) ;while

;;;-------------------------------------------------------------------------
;;;;   修改多行文字
;;;-------------------------------------------------------------------------

(setq s (ssget "X" '((0 . "MTEXT"))) n 0)
(if s
  (repeat (sslength s)
    (setq szp nil)
    (setq ss (ssname s n) sss (entget ss) n (1+ n))
    (setq s3 (cdr (assoc '3 sss)))
    (if s3 (progn
      (setq s3a (rep_GGf s3))
      (if (/= s3 s3a)
        (progn
          (setq sss (subst (cons 3 s3a) (assoc '3 sss) sss))
          (entmod sss)
        ) ;progn
      ) ;if
           ) ;progn
    ) ;if
    ;;;3
    (setq s1 (cdr (assoc '1 sss)))
    (setq s1a (rep_GGf s1))
    (if (/= s1 s1a)
      (progn
        (setq sss (subst (cons 1 s1a) (assoc '1 sss) sss))
        (entmod sss)
      ) ;progn
    ) ;if
  ) ;repeat
) ;if s



(command "regen")

(princ "\n结果: 修改(统一)文字的字体已经成功完成!")
(princ)

;;;==============================END========================================
```



##### （3）tabt2.lsp（画表格，已经解决）

下面是可以画出图的代码

**注意这里的字体可能会乱 如果出现问号就是字体的问题**

```lisp
; 此程序用于绘制表格（插入预制块并根据行数绘制线条）
(setq rows nil)  ; 表格行数，默认未指定
(setvar "blipmode" 0)  ; 关闭点回显（AutoCAD中用于调试）
(setvar "cmdecho" 0)   ; 关闭命令回显（不显示命令输出）

; ========== 获取视图和屏幕相关参数 ==========
(setq cc (getvar "viewctr"))         ; 获取当前视图中心点
(setq ych (float (getvar "viewsize"))) ; 获取视图高度（y方向大小）
(setq xch (float (* (/ 574.0 414) ych))) ; 宽度比例缩放，确保显示完整 tabt2

(setq SCREEN (getvar "SCREENSIZE"))  ; 屏幕像素尺寸
(setq SCR (/ (car SCREEN) (cadr SCREEN) 2.0)) ; 屏幕宽高比（用于缩放 slide）
(setq ypt (list (- (car cc) (* SCR ych))     ; 计算左下角基准点 ypt
                (- (cadr cc) (* 0.5 ych))))  ; 类似画布左下角，供 vslide 显示参考

(setq nxcal (/ xch 3.0))   ; 水平方向分为3列，每列宽度
(setq nycal (/ ych 3.0))   ; 垂直方向分为3行，每行高度
(setq nxc (* nxcal 0.03))  ; 左右偏移，微调用于高亮框显示
(setq nyc (* nycal 0.04))  ; 上下偏移，微调用于高亮框显示




(setq slidename (strcat (get-bpath) "\\tab\\tabt2.sld"))  ; 拼接滑图路径
(princ (strcat "\n 滑图路径: " slidename))              ; 打印滑图路径，便于调试

(if (findfile slidename)
  (command "_.vslide" slidename)
  (prompt "\n 未找到 tabt2.sld，请检查 tab 文件夹内容是否完整")
)



 ; 显示滑图 tabt2.sld

; ========== 用户点击交互 ==========
(prompt "\n SELECT ONE:")     ; 提示用户点击表格缩略图
(setq xt t pt1 (grread t)) ; 进入交互循环，读取鼠标点

(while (and xt pt1)
  (setq pp (cadr pt1))  ; 当前鼠标坐标
  (setq drtx (- (car pp) (car ypt))) ; x方向偏移量
  (setq drty (- (cadr pp) (cadr ypt))) ; y方向偏移量
  (setq nx (fix (/ drtx nxcal))) ; 判断横向是第几列（0-2）
  (setq ny (fix (/ drty nycal))) ; 判断纵向是第几行（0-2）

  ; 计算四个角点，用于绘制点击高亮框
  (setq pto (list (+ (car ypt) (* nx nxcal)) (+ (cadr ypt) (* ny nycal))))
  (setq pto (dxy pto nxc nyc)) ; 稍微平移框起点
  (setq pt2 (polar pto 0 (* nxcal 0.94)))        ; 右下点
  (setq pt3 (polar pt2 (/ pi 2.) (* nycal 0.92))) ; 右上点
  (setq pt4 (polar pto (/ pi 2.) (* nycal 0.92))) ; 左上点

  ; 如果点的区域变化了，重绘框线
  (if (and (or (/= nx nnx) (/= ny nny)) nnx nny)
    (progn
      (grdraw mpto mpt2 0) ; 清除上一次高亮框（黑色）
      (grdraw mpt2 mpt3 0)
      (grdraw mpt3 mpt4 0)
      (grdraw mpt4 mpto 0)
      
      (grdraw pto pt2 2) ; 绘制新框（绿色高亮）
      (grdraw pt2 pt3 2)
      (grdraw pt3 pt4 2)
      (grdraw pt4 pto 2)
    )
  )

  ; 记录这次框的位置
  (setq nnx nx nny ny mpto pto mpt2 pt2 mpt3 pt3 mpt4 pt4)

  ; 读取下一次点击
  (setq pt1 (grread t))
  ; 如果用户点击确认（鼠标点击），跳出循环
  (if (= (car pt1) 3) (setq pp (cadr pt1) xt nil))
)

(setq joty (strcat (itoa ny) (itoa nx))) ; 合成代号，如 ny=1, nx=1 -> joty="11"
(redraw) ; 清除临时线

; ========== 插入图块并绘表格 ==========
(if (= joty "11")
  (setq rows (getint "\nNumber of rows: ")) ; 如果是11表格，要求输入行数
)

;; 【新增】先强制修复 Standard 样式为中文字体，防止图块中的文字使用旧字体出错
(command "-style" "Standard" "hztxt.shx" "" 0.75 "" "N" "N" "N")
;;; ========== 插入图块前设置字体样式 ==========
(if (not (tblsearch "style" "TSSD_Rein"))
  ;; 【说明】确保图块插入时使用支持中文的字体样式，否则文字显示问号
  (command "-style" "TSSD_Rein" "hzshx.shx" "" 0.75 "" "N" "N" "N")
)
(setvar "textstyle" "TSSD_Rein")  ; 【说明】强制切换当前文字样式为我们自定义的，确保插入文字生效

(setq pt (getpoint "\nInsert point: "))
(setq idwg (strcat (get-bpath) "\\tab\\btt" joty))
(princ (strcat "\n 插入路径: " idwg ".dwg")) ; 调试用
(command "insert" idwg pt "" "" ""); 插入图块（使用默认比例和角度）




; ========== 如果是11号表格，还要画线框 ==========
(if (= joty "11")
  (progn
    (setq mainLayer "01")
    (setq auxLayer "06")
    (getla)              ; 保存当前图层

     ;; 设置为主线图层（表格外框）
    (if (tblsearch "layer" mainLayer)
      (setla mainLayer);(setla "01")的等价写法
      (prompt (strcat "\n 主线图层 " mainLayer " 不存在，跳过设置"))
    )
    ;(setla "06")

    ; 计算表格左下角基点（ppt）
    (setq ppt (dxy pt -19000 (- -4500 (* rows 1000))))

    ; 绘制外围矩形
    (command "line" (dxy ppt 0 (* rows 1000)) ppt (dxy ppt 18500 0)
                    (dxy ppt 18500 (* rows 1000)) "")

    ; 设置为辅助线图层
    ;; 设置为辅助线图层（列线和横线）
    (if (tblsearch "layer" auxLayer)
      (setla auxLayer);(setla "06")的等价写法
      (prompt (strcat "\n 辅助图层 " auxLayer " 不存在，跳过设置"))
    )
    ;(setla "06")

    ; 按照列宽绘制表格列线
    (command "line" (dxy ppt 2000 0) (dxy ppt 2000 (* rows 1000)) "")
    (command "line" (dxy ppt 3200 0) (dxy ppt 3200 (* rows 1000)) "")
    (command "line" (dxy ppt 6800 0) (dxy ppt 6800 (* rows 1000)) "")
    (command "line" (dxy ppt 8300 0) (dxy ppt 8300 (* rows 1000)) "")
    (command "line" (dxy ppt 9300 0) (dxy ppt 9300 (* rows 1000)) "")
    (command "line" (dxy ppt 10300 0) (dxy ppt 10300 (* rows 1000)) "")
    (command "line" (dxy ppt 11700 0) (dxy ppt 11700 (* rows 1000)) "")
    (command "line" (dxy ppt 13100 0) (dxy ppt 13100 (* rows 1000)) "")
    (command "line" (dxy ppt 14500 0) (dxy ppt 14500 (* rows 1000)) "")

    ; 横线（按行数）
    (setq i 1)
    (repeat (- rows 1)
      (command "line"
        (dxy ppt 2000 (* i 1000))
        (dxy ppt 13100 (* i 1000))
        ""
      )
      (setq i (+ i 1))
    )

    (setla la) ; 恢复原图层
  )
)

```

这个里 btt10这文件太老了不能用 其他的还有11那个还没试

```
(load "D:/cad_project/tssdAutocad2007/tssd2007/acad123.lsp")
```



```
(load "C:\Program Files\TszCAD\TSDP2021\Sys2021\tssd2007/acad123.lsp")

```



##### （4）men.lsp （数据处理）

| **编号** | **LISP 文件路径**       | **功能描述**                                                 | **依赖的外部文件**       | **操作方式**        | **是否可用**              |
| -------- | ----------------------- | ------------------------------------------------------------ | ------------------------ | ------------------- | ------------------------- |
| 30       | D:/JYS2/TAB/mater0.lsp  | 批量读取图纸表格中的编号、截面、长度、数量等信息，计算总重量并重新标注 | /hxw/lsp/xg.dat          | 框选区域            |                           |
| 31       | D:/JYS2/TAB/mater1.lsp  | 手动输入构件信息（编号、截面、长度、数量）并标注重量         | /hxw/lsp/xg.dat          | 鼠标点击 + 输入     |                           |
| 32       | D:/JYS2/TAB/mater2.lsp  | 批量读取构件信息，分类汇总总长与总重，写入 `.dat` 文件       | 用户输入的 `.dat` 文件   | 框选构件            |                           |
| 33       | D:/JYS2/TAB/mater3.lsp  | 合并两个 `.dat` 材料清单文件，生成新文件                     | 多个 `.dat` 文件         | 手动输入文件名      |                           |
| 34       | D:/JYS2/TAB/mater4.lsp  | 排序并格式化 `.dat` 材料清单，生成 `.cll` 报表               | xg.dat、输入 `.dat` 文件 | 自动处理            |                           |
| 20       | D:/JYS2/TAB/total.lsp   | 把选中文字或标注中的数字相加，并在图上标注结果               | 无                       | 选择对象 + 点位置   | 可以，已支持标注dimension |
| 21       | D:/JYS2/TAB/mult.lsp    | 将选中文字中的数字乘以输入倍数，直接修改原文字               | 无                       | 选择对象 + 输入倍数 | 可以 暂时仅支持text       |
| 22       | D:/JYS2/TAB/plus.lsp    | 将选中文字中的数字加上输入值，并修改原文字                   | 无                       | 选择对象 + 输入数值 | 可以  也只支持text        |
| 23       | D:/JYS2/TAB/challt.lsp  | 批量替换选中图中文字内容                                     | 无                       | 输入查找和替换内容  | 可以 同上                 |
| 24       | D:/JYS2/TAB/int.lsp     | 将选中图中文字中的小数转为整数                               | 无                       | 批量处理            | 可以 同上                 |
| 25       | D:/JYS2/TAB/textadd.lsp | 在选中文字末尾追加用户输入内容                               | 无                       | 输入追加内容        | 可以                      |
| 10       | D:/JYS2/TAB/clline.lsp  | 绘制折线段，每段插入带编号的块参照                           | 图块 /hxw/dwg/num        | 手动画线            | 不能 找不到这个num        |
| 11       | D:/JYS2/TAB/clnum.lsp   | 鼠标点击已有线段，在每段终点插入编号块                       | 图块 D:/JYS2/num         | 鼠标选择线段        | 不能 找不到这个Num        |
| 12       | D:/JYS2/TAB/mater2.lsp  | 同 32，重复使用                                              | 同上                     | 框选构件            |                           |
| 13       | D:/JYS2/TAB/datatj.lsp  | 统计每类文字出现次数并输出文本文件                           | 无                       | 选择文字            |                           |

好像可以  

acad暂时没办法

menuload可以修改为用cuix  其实是一样的  但是我还是得先解决路径问题





### 接下来：

1，写一个说明文档

1，acad的加载和menuload的使用    2，字体的选择   3，文件解压路径保持一致  4，btt10有问题  已经解决 换了个文件即可

5  修改prg路径下的acaddoc   然后注意 这里我把自己的插件里的acad改成了acad123 不然搜索不到





1，对结构插件代码进行优化，替换原有硬编码路径为自适应路径。

2，重构插件中无法运行的的初始化功能和表格插入功能。

3，与中望团队就插件移植方案进行沟通，明确可行的技术路径和对接方式。





1，解决结构插件现有问题并整合，提交版本供同事测试。

2，搭建中望开发环境，准备启动插件移植工作。









中望的问题：

command 命令无法正常调用-----中望没有大字体那一项

```
(defun init-tabt2-env ()
  ;; 强制设置 Standard 样式为中文字体
  (if (not (tblsearch "style" "Standard"))
    (command-s "-style" "Standard" "hztxt.shx" "hzbig.shx" "0.75" "1.0" "0" "N" "N" "N")
    (command-s "-style" "Standard" "hztxt.shx" "hzbig.shx" "0.75" "1.0" "0" "N" "N" "N") ; 强制重设
  )

  ;; 创建并设置自定义文字样式 TSSD_Rein
  (if (not (tblsearch "style" "TSSD_Rein"))
    (command-s "-style" "TSSD_Rein" "hzshx.shx" "hzbig.shx" "0.75" "1.0" "0" "N" "N" "N")
  )
  (setvar "textstyle" "TSSD_Rein")

  ;; 创建图层
  (defun ensure-layer (lname color ltype)
    (if (not (tblsearch "layer" lname))
      (command "-layer" "n" lname "c" color lname "lt" ltype lname "")
    )
  )
  (ensure-layer "01" "7" "Continuous")
  (ensure-layer "06" "8" "Continuous")
)
```

替换 看看cuix到底是怎么个事情





**好像用mns会报错 尽量用cuix**



判断功能是否存在 是不是需要做

看一下说明文档 目前来看是都需要做的

1，布置轴网到基础承台   再到算构建2  不涉及已有功能







TSSD 插件根据其功能模块可以分为以下四个工具条。在调研探索者平台的官方 API ，并结合插件原始代码结构分析后，对 TSSD 插件各工具条的功能来源和开发方式进行梳理。整体功能可分为调用探索者内置接口的可移植类功能，以及依赖自定义 Lisp 脚本的需重构开发类功能两大类：

1. 钢筋、轴网工具条：大部分功能在中望最新版探索者平台中已由官方提供标准化 API 接口（如轴网、布柱、布墙、配筋等），只需在新平台中对接调用，开发工作量较小。
2. 符号工具条：功能主要依赖插件本地编写 `.lsp` 文件（如 `ELVTA.lsp`、`JD1.lsp`、`PMFH.lsp` 等），探索者平台未提供对应 API 接口，且与中望平台存在兼容性问题，因此需对相关功能逻辑进行完整重构与重新开发，开发工作量较大。
3. 常用工具条：常用工具条中部分功能（如文字处理、标注、型钢绘制等），探索者提供了API接口，可直接适配移植至中望平台无需开发。但批量插入各类表格和处理数据相关功能依赖本地嵌套调用的 `.lsp` 脚本，且部分代码中望 CAD 不支持，需寻找其他技术方案重构开发，开发工作量。

```
-style
CO3
hztxt.shx

0.85

N
N
N

```



# 中望插件移植

目前有三个板块需要移植：

探索者插件   很长的代码插件   很短但功能嵌套实际很长的表格插件

### 📌 1. 常用工具条

| 功能名称 | 是否测试能运行 | 运行方法                                    | 后续改进       |
| -------- | -------------- | ------------------------------------------- | -------------- |
| 线性标注 | 可以           | 1.起点  2，终点  3,标注的距离即可           | 没有点的捕捉   |
| 移动尺寸 | 可以           | 1，必须选中标注  2，选择移动到的位置即可    | 无             |
| 多行编辑 | 可以           | 直接编辑文字就行了                          | 无             |
| 写附注   | 可以           | 快速插入常用说明文字                        | 无             |
| 文字输入 | 可以           | 按照标注文字类别，快速输入文字              | 无             |
| 通用编辑 | 可以           | 鼠标点                                      | 无             |
| 统一字高 | 可以           | 鼠标批量点然后输入字高                      | 无             |
| 型钢绘制 | 可以           | 内置功能 打开探索者用的                     | 无  也无法修改 |
| 螺栓绘制 | 可以           | 同上 内置                                   | 无 也无法修改  |
| 焊缝标注 | 可以           | 同上 内置                                   | 无 也无法修改  |
| 改变线宽 | 可以           | 内置 但是可以输入想要改变的线宽 有一点 操作 | 无             |
| 查找替换 | 可以           | 内置 替换文字 还有花活儿 但是不用管         | 无             |
| 常用表格 | **不可以**     |                                             |                |
| 数据处理 | **不可以**     |                                             |                |



------

### 📌 2. 字工具条

| 功能名称 | 是否测试能运行 | 运行方法                                         | 后续改进                      |
| -------- | -------------- | ------------------------------------------------ | ----------------------------- |
| 选层显示 | 可以运行       | 鼠标点击即可，貌似是让某些图层显示               | 无                            |
| 标注断开 | 可以           | 鼠标点击 在标注上选取点 直接一分为二             | 无 这功能好强啊               |
| 线长取齐 | 可以           | 绿色的尺寸线  拉长用于标注指示的部分             | 无                            |
| 多行编辑 | 可以           | 对文字编辑而已  无非是功能强大                   | 不能多行啊？                  |
| 组开关   | 不确定         | **可以开关 但是不知道有效果没**                  | 让博士测试                    |
| 平法标注 | 可以           | 是不同的标注方法 但是不影响文字内容 试用一个即可 | 无                            |
| 引出标注 | 可以           | 选择多个点 但是只加一个标注                      | 不支持中文 先用英文再修改即可 |



------

### 📌 3. 符号工具条

| 功能名称       | 是否测试能运行                                               | 运行方法                                                     | 后续改进      |
| -------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------- |
| 立面标高       | 可以                                                         | 鼠标点三下                                                   | 无            |
| 平面标高       | 可以，但是和立面标高稍有区别  貌似是在某个具体的点上执行     | 点两下                                                       | 无            |
| 本图节点       | 可以，就是加节点                                             | 点击                                                         | 无            |
| 详图节点       | 同上 只是节点里有两个数字                                    | 点击                                                         | 无            |
| 索引节点       | 同上 进一步  有起点和终点的两个数字                          | 点击                                                         | 无            |
| 改变线宽       | 可以                                                         | 1，输入线宽   2，选择线  3，回撤                             | 无            |
| 构件延长缩短   | 可以  红线可以用 蓝线也可以 但是这功能感觉没啥意义           | 顺着来                                                       | 无 不懂       |
| 切角           | 画墙角  可以用                                               | 第一个点选墙角点 第二个点选方向 但是这个方向没太懂  也无所谓了 | 无            |
| 横剖切         | 可以                                                         | 一样的 花两道杠而已                                          | 无            |
| 竖剖切         | 可以                                                         | 一样 只是竖着                                                | 无            |
| 剖面号         | 可以                                                         | 输入1  得到1-1  没法1-2  只能自己出来再改                    | 后续让他能1-2 |
| 零件号         | 可以                                                         | 标识是折线 到终点了回车  输入零件号                          | 无            |
| 轴线号         | 可以                                                         | 紫色的圈圈 标识轴线                                          | 无            |
| 带方向轴线号   | 可以                                                         | 同上 只是有两个紫色圈圈                                      | 无            |
| 两点构件       | 可以                                                         | 选两个点插入黄色钢结构                                       | 无            |
| 设备基础螺栓   | **用不了**                                                   |                                                              |               |
| 常用捕捉设置   | 可以                                                         | 就是默认了一个捕捉设置 没法修改                              | 无            |
| 线型比例切换   | **不可以**                                                   | **修改比例因子 建议重构这个功能**                            |               |
| 统一字体       | 可以运行，且已修改过，虽然不会修改字体本身的样式，但是会把所有字体全部洗刷成统一格式  也算解决了 | 点击即可                                                     |               |
| 关闭图幅代码层 | 用不明白 但是**可以用** 就是对图层的各种复杂操作             | 反正能用                                                     | 无            |
| 圆剖切面       | 可以                                                         | 画剖面线                                                     | 无            |
| 加箭头         | 可以                                                         | 在直线靠近的一段加箭头                                       | 无            |
| 引出斜线       | 可以                                                         | 就是画一段斜线 管他啥意思                                    | 无            |
| 文字统一修改   | 可以 **但有问题**                                            | autocad支持输入中文   但是中望不支持中文                     |               |
| 动态延长       | 可以                                                         | 修改直线长度而已                                             | 无            |

### 



```
ID______________0 [_Button("线型比例切换", "RCDA0561.BMP", "RCDATA_16_LAYTRANS")]^C^C_LTSCALE ( / 1000 ( / 100. (car(&mxno t)))) REGEN


ID__SET_LTSCALE [_Button("线型比例切换", "RCDA0561.BMP", "RCDATA_16_LAYTRANS")]^C^C(load-plugin "set_ltscale.lsp") set_ltscale


```







#### 一，开发计划--根据上述测试结果梳理

| 序号 | 功能名称     | 所属工具条 | 问题说明                               | 建议开发方向                      |
| ---- | ------------ | ---------- | -------------------------------------- | --------------------------------- |
| 1    | 常用表格     | 常用工具条 | 无法运行，按钮无响应                   | **可以运行**                      |
| 2    | 数据处理     | 常用工具条 | 无法运行，按钮无响应                   | 需分析 `MEM.lsp`，**忽略 不改了** |
| 3    | 设备基础螺栓 | 符号工具条 | 功能无法使用，疑似缺少依赖或平台不兼容 | 没高亮，**通过左下角打印解决**    |
| 4    | 线型比例切换 | 符号工具条 | AutoCAD 兼容，**中望CAD无效**          | **重写了，已实现**                |
| 5    | 剖面号       | 符号工具条 | 输入仅支持 1 → 1-1，**不能 1-2 组合**  | 不用改                            |
| 6    | 文字统一修改 | 符号工具条 | AutoCAD 支持中文，中望CAD无法输入中文  | 不用改                            |

#### 二，复杂功能修改---mem.lsp---忽略

| joty值 | 加载模块   | 问题描述                   | 后续处理建议                 |
| ------ | ---------- | -------------------------- | ---------------------------- |
| 30     | mater0.lsp | 依赖 dat 数据，来源未明    | 向同事确认数据格式与来源     |
| 31     | mater1.lsp | 同上                       | 同上                         |
| 32     | mater2.lsp | 同上                       | 同上                         |
| 33     | mater3.lsp | 同上                       | 同上                         |
| 34     | mater4.lsp | 同上                       | 同上                         |
| 10     | clline.lsp | 依赖图块 num.dwg           | 向同事索要 num.dwg 文件      |
| 11     | clnum.lsp  | 同上                       | 同上                         |
| 13     | datatj.lsp | 涉及数据统计，逻辑依赖未知 | 向同事确认统计数据来源与格式 |
| 12     | mater2.lsp | 重复加载，疑似冗余         | 可清理或合并逻辑             |

#### 三，要点汇总

1，如果有不支持中文的 先创建然后直接修改成中文即可 无法修改

2，去问涂博士两个问题 一个是比例因子是啥 还有一个是dat文件一般是干啥的







```
docker run --name seata \
-p 8099:8099 \
-p 7099:7099 \
-e SEATA_IP=192.168.244.129 \
-v ./seata:/seata-server/resources \
--privileged=true \
--network hm-net \
-d \
seataio/seata-server:1.5.2
```

```yaml
server:
  port: 8085
seata:
  registry: # TC服务注册中心的配置，微服务根据这些信息去注册中心获取tc服务地址
    type: nacos # 注册中心类型 nacos
    nacos:
      server-addr: 192.168.244.129:8848 # nacos地址
      namespace: "" # namespace，默认为空
      group: DEFAULT_GROUP # 分组，默认是DEFAULT_GROUP
      application: seata-server # seata服务名称
      username: nacos
      password: nacos
  tx-service-group: hmall # 事务组名称
  service:
    vgroup-mapping: # 事务组与tc集群的映射关系
      hmall: "default"

spring:
  application:
    name: trade-service
  profiles:
    active: dev
  datasource:
    url: jdbc:mysql://${hm.db.host}:3306/hm-trade?useUnicode=true&characterEncoding=UTF-8&autoReconnect=true&serverTimezone=Asia/Shanghai
    driver-class-name: com.mysql.cj.jdbc.Driver
    username: root
    password: ${hm.db.pw}

  config:
    import: nacos:shared-test.yaml?group=DEFAULT_GROUP&namespace=

  cloud:
    nacos:
      server-addr: 192.168.244.129:8848 # nacos地址
      config:
        file-extension: yaml
        refresh-enabled: true
      #config:
      #  import-check:
      #    enabled: false
mybatis-plus:
  configuration:
    default-enum-type-handler: com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler
  global-config:
    db-config:
      update-strategy: not_null
      id-type: auto
logging:
  level:
    com.hmall: debug
  pattern:
    dateformat: HH:mm:ss:SSS
  file:
    path: "logs/${spring.application.name}"
knife4j:
  enable: true
  openapi:
    title: 交易服务接口文档
    description: "交易服务接口文档"
    email: zhanghuyi@itcast.cn
    concat: 虎哥
    url: https://www.itcast.cn
    version: v1.0.0
    group:
      default:
        group-name: default
        api-rule: package
        api-rule-resources:
          - com.hmall.trade.controller
hm:
  jwt:
    location: classpath:hmall.jks
    alias: hmall
    password: hmall123
    tokenTTL: 30m
  auth:
    excludePaths:
      - /search/**
      - /users/login
      - /items/**
      - /hi
# keytool -genkeypair -alias hmall -keyalg RSA -keypass hmall123 -keystore hmall.jks -storepass hmall123

```

```
spring:
  application:
    name: item-service
  profiles:
    active: dev
  config:
    import:
      - nacos:shared-jdbc.yaml?group=DEFAULT_GROUP
      - nacos:shared-log.yaml?group=DEFAULT_GROUP
      - nacos:shared-swagger.yaml?group=DEFAULT_GROUP
      - nacos:shared-seata.yaml?group=DEFAULT_GROUP
      - nacos:shared-feign.yaml?group=DEFAULT_GROUP
      - nacos:shared-test.yaml?group=DEFAULT_GROUP

  cloud:
    nacos:
      server-addr: 192.168.244.129:8848
      config:
        file-extension: yaml
        refresh-enabled: true

server:
  port: 8081  # 本地端口本地配置，避免覆盖
feign:
  okhttp:
    enabled: true # 开启OKHttp连接池支持
  sentinel:
    enabled: true # 开启Feign对Sentinel的整合
hm:
  swagger:
    title: 黑马商城商品管理接口文档
    package: com.hmall.item.controller
  db:
    database: hm-item

```

1，完成结构插件剩余模块的测试，梳理插件安装流程，编写说明文档

2，和同事沟通确认下一步工作方向