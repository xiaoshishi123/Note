# 结构插件移植

## 1，个人问题梳理

1，探索者软件是否不是必须的 因为前面那两个已经是完整的插件了  只是用于一键继承的壳子



2，探索者和autocad的版本



3，具体的功能实用   







## 2，插件功能整理

### 一、整体定位

这两个文件夹共同组成了“结构工具条”插件的核心内容，用于在 AutoCAD 中实现结构图相关的绘图、标注、构件布置等功能。

------

### 二、组成与分工



| 文件夹      | 主要内容                                        | 功能定位                                                     |
| ----------- | ----------------------------------------------- | ------------------------------------------------------------ |
| `jys2-2014` | 大量 `.lsp` 脚本（如 `ELVT.LSP`, `ANCHOR.LSP`） | 🔧 **功能实现层**：包含所有命令的核心逻辑脚本，是插件的执行部分 |
| `tssd2007`  | `.mns` 菜单文件、`.bmp` 图标、`Acad.lsp` 加载器 | 🎛️ **界面与加载层**：负责定义按钮界面、图标绑定与插件自动加载入口 |

------

### 三、加载与调用关系

AutoCAD 启动
   ↓
加载 Acad.lsp（插件入口）
   ↓
加载菜单 TssdUser.mns → 显示工具条按钮
   ↓
用户点击按钮 → 触发菜单中绑定命令（如 ELVT）
   ↓
ELVT 命令在 jys2 的 ELVT.LSP 中实现 → 实际执行功能



------

### 四、各组件具体作用

#### ✅ `jys2-2014`

- `.lsp` 文件：每个文件对应一个命令，如 `ELVT`, `ANCHOR`, `CHTEXT`
- 提供所有功能的逻辑定义，可在中望CAD中独立加载运行

#### ✅ `tssd2007`

- `TssdUser.mns`：定义菜单结构与按钮命令绑定
- `.bmp` 图标：提供按钮的图形外观
- `Acad.lsp`：启动时统一加载 `.lsp` 脚本并导入菜单界面



### 总结一句话

> `tssd2007` 管“界面和入口”，`jys2-2014` 管“命令和功能”，结构工具条插件通过 `Acad.lsp` 把菜单（.mns）和脚本（.lsp）联合起来，形成完整功能。





## 3，Acad.lisp

```lisp
;;; 以下几项是在注册表中进行存储，用于设置 AutoCAD 的工作环境
(setvar "FileDia" 1)      ; 显示文件对话框（如打开/保存）
(setvar "CmdDia" 1)       ; 显示打印、外部命令的对话框
(setvar "MenuCtl" 0)      ; 菜单控制设置为键盘输入优先

;;; 以下几项也保存在注册表中，用于设置绘图行为
(setvar "MirrText" 0)     ; 镜像文字时不翻转（保持可读）
(setvar "LimCheck" 0)     ; 允许在图形界限外绘图
(setvar "AttMode" 1)      ; 所有属性都显示
(setvar "AttDia" 0)       ; 属性编辑使用命令行模式，不弹出对话框
(setvar "PickStyle" 0)    ; 禁用组选择和关联填充选择

;; 以下为启动函数（注释掉了），可能原本用于菜单加载和初始化提示
;; 如果你打开 AutoCAD 的时候，这个插件没加载菜单，就自动帮你加载它的菜单文件，
;; 并执行一些初始化设置，还在下面状态栏上显示“jys Version 1.0”，并且在命令行里提示“结构jys v2.0
;; (defun s::startup ()
;;   (if (not (menugroup "jys")) (command "menu" "jys.mnu" "prnsc"))
;;   (command "spsinit")
;;   (princ "\n≡ 结构jys v2.0 ≡")
;;   (setvar "modemacro" "jys Version 1.0")
;;   (princ)
;; )

;;; ========== 工具函数 ==========

(defun disxy (pt x y)
  ;; 将点 pt 按 x, y 平移后的新坐标
  (list (+ (car pt) x) (+ (cadr pt) y)))

(defun tg (x)
  ;; 计算 tan(x)
  (/ (sin x) (cos x)))

;;; ========== 全局变量初始化 ==========
(setq dr-nm nil comctr '(0) drnumb 0 ar-tab nil)
(setq crnumb nil drpt1 nil drpt2 nil scl-1 nil scl-2 nil axiscale 1.0)
(setq comnrd nil drtype nil arname nil fdt nil unidis 100)

;;; ========== 清除对象捕捉设置命令 ==========
(defun c:clean ()
  (setvar "osmode" 0) ; 关闭所有对象捕捉
  (setq atomlist (member 'C:CLEAN atomlist)) ; 检查命令是否存在于命令列表
  'OK! ; 返回 OK
)

;;; ========== 从用户变量读取比例参数 ==========
(setq axiscale (getvar "userr1")) ; 获取用户变量1（主比例） 控制绘图的主缩放倍数（比如：1cm画成2cm）
(setq scl-2 (getvar "userr2"))     ; 获取用户变量2（副比例）  控制某些功能里的微调缩放，精细控制尺寸

(if (= scl-2 0) (setq scl-2 10.0)) ; 如果 scl-2 未设置，默认设为 10
(setq scl-2 (/ 1.0 scl-2))         ; scl-2 取倒数

(if (= axiscale 0) (setq axiscale 2.0)) ; 默认主比例为 2.0

(load "d:/jys2-2014/tszsc.fas") ; 加载外部功能模块

;;; ========== 读取文件中以某关键词s1开头的行 ==========
(defun rddatf (s1 file / f1 ctr)
  (setq f1 (open file "r") tab (read-line f1) ctr 1)
  (while (and tab ctr)
    (setq tab (read tab))
    (if (= s1 (car tab)) (setq ctr nil) (setq tab (read-line f1)))
  )
  (close f1) tab ; 返回匹配的行内容
)

;;; 点平移函数（简写版）
(defun dxy (pt1 xx yy)
  (setq pt1 (list (+ (car pt1) xx) (+ (cadr pt1) yy)))
)

;;; 获取当前图层
(defun getla (/) (setq la (getvar "clayer")))

;;; 设置当前图层
(defun setla (lla) (command "layer" "s" lla ""))

;;; ========== 加载更改宽度模块命令 ==========
(defun c:cw (/ object num width obj1 name cenpoint diam)
  (load "D:/jys2-2014/chwidth")
)

;;; ========== 复制选择对象命令 ==========
;; 你输入 c，就能框选 CAD 图元并复制
(defun c:c (/ s)
  (setq s (ssget)) ; 获取用户选择
  (if s (command "copy" s "" "m" pause)) ; 执行复制命令
  (princ)
)

;;; ========== 加载其他外部命令 ==========
;; 按需加载外部功能模块
(defun c:bb () (load "D:/jys2-2014/break.lsp"))
(defun c:1 ()  (load "D:/jys2-2014/rof.lsp"))
(defun c:5 ()  (load "D:/jys2-2014/TXTH.lsp"))
(defun c:oo () (load "D:/jys2-2014/roff"))
(defun c:hh () (load "D:/jys2-2014/autoelev"))

;;; 设置对象捕捉模式为 679（组合模式）
(defun c:aa ()
  (setvar "osmode" 679)
)

;;; 图层属性更改函数（颜色、图层、线型）
(defun chp (c la lt / s)
  (setvar "cmdecho" 0) ; 关闭命令回显
  (setq s (ssget))     ; 获取选择集
  (if s
    (command "change" s "" "p" "c" c "la" la "lt" lt "")
  )
  (setvar "cmdecho" 1)
  (princ)
)

;;; 快捷设置图层属性命令（0~8图层）
;;; 调用上一个函数  一键归类图形到不同编号的图层，方便统一管理和打印样式控制
(defun c:00 () (chp "bylayer" "0"  "bylayer"))
(defun c:11 () (chp "bylayer" "01" "bylayer"))
(defun c:22 () (chp "bylayer" "02" "bylayer"))
(defun c:33 () (chp "bylayer" "03" "bylayer"))
(defun c:44 () (chp "bylayer" "04" "bylayer"))
(defun c:55 () (chp "bylayer" "05" "bylayer"))
(defun c:66 () (chp "bylayer" "06" "bylayer"))
(defun c:77 () (chp "bylayer" "07" "bylayer"))
(defun c:88 () (chp "bylayer" "08" "bylayer"))

;;; ========== 字体样式设置函数 ==========
(defun mstyle (stname sthigh stwidth)
  ;; 传入字体名、文字高、宽度比，设置对应样式
  (progn
    (cond
      ((= (strcase stname) "SIMPLEX") (command "style" "simplex" "simplex,hztxt" sthigh stwidth "" "" "" ""))
      ((= (strcase stname) "COMPLEX") (command "style" "complex" "txt,hztxt" sthigh stwidth "" "" "" ""))
      ((= (strcase stname) "ROMAND")  (command "style" "romand"  "simplex,hztxt" sthigh stwidth "" "" "" ""))
      ((= (strcase stname) "GREEKC")  (command "style" "greekc"  "txt,hztxt" sthigh stwidth "" "" "" ""))
      ((= (strcase stname) "STANDARD")(command "style" "standard" "txt,hztxt" sthigh stwidth "" "" "" ""))
      ((= (strcase stname) "HZ_ST")   (command "style" "hz_st"   "txt,hztxt" sthigh stwidth "" "" "" ""))
    )
    (setq sthigh nil) ; 清空高设置
  )
)

```



## ✅ `acad.lsp` 中使用的 `setvar` / `getvar` 变量说明表（Markdown 格式）

| 变量名    | 类型   | 使用方式                               | 说明                                            |
| --------- | ------ | -------------------------------------- | ----------------------------------------------- |
| FileDia   | setvar | (setvar "FileDia" 1)                   | 是否显示“打开/保存文件”对话框，1=显示，0=命令行 |
| CmdDia    | setvar | (setvar "CmdDia" 1)                    | 是否显示“打印等命令”对话框，1=弹窗，0=命令行    |
| MenuCtl   | setvar | (setvar "MenuCtl" 0)                   | 控制屏幕菜单是否响应命令，0=不响应              |
| MirrText  | setvar | (setvar "MirrText" 0)                  | 镜像文字时是否翻转，0=保持方向不变              |
| LimCheck  | setvar | (setvar "LimCheck" 0)                  | 是否限制在图形界限内作图，0=不限                |
| AttMode   | setvar | (setvar "AttMode" 1)                   | 属性是否显示，1=全部属性可见                    |
| AttDia    | setvar | (setvar "AttDia" 0)                    | 是否使用属性对话框，0=命令行输入                |
| PickStyle | setvar | (setvar "PickStyle" 0)                 | 是否启用编组选择，0=禁用组选择                  |
| OsMode    | setvar | (setvar "OsMode" 0 / 679)              | 对象捕捉模式，0=关闭，679=开启多种吸附点        |
| Cmdecho   | setvar | (setvar "Cmdecho" 0 / 1)               | 是否显示命令执行过程，0=不显示                  |
| Modemacro | setvar | (setvar "Modemacro" "jys Version 1.0") | 设置状态栏文字（本例中被注释掉）                |
| Userr1    | getvar | (getvar "Userr1")                      | 读取主比例系数，插件自定义用途                  |
| Userr2    | getvar | (getvar "Userr2")                      | 读取副比例系数，用作比例倒数                    |
| Clayer    | getvar | (getvar "Clayer")                      | 获取当前图层名（用于图层切换）                  |

## ✅ 命令行可用的用户命令（`(defun c:xxx)`）

| 命令名  | 命令输入 | 功能说明                                         |
| ------- | -------- | ------------------------------------------------ |
| `clean` | `clean`  | 清除对象捕捉设置（关闭所有吸附点）               |
| `cw`    | `cw`     | 加载 chwidth.lsp 模块（更改线宽）                |
| `c`     | `c`      | 执行复制操作（用户选择 → 复制）                  |
| `bb`    | `bb`     | 加载 break.lsp 模块（断线命令）                  |
| `1`     | `1`      | 加载 rof.lsp 模块（功能未知）                    |
| `5`     | `5`      | 加载 TXTH.lsp 模块（文字处理）                   |
| `oo`    | `oo`     | 加载 roff 模块（功能未知）                       |
| `hh`    | `hh`     | 加载 autoelev 模块（自动标高）                   |
| `aa`    | `aa`     | 设置对象捕捉模式为 679（端点、中点、交点等启用） |
| `00`    | `00`     | 设置图层为 "0"，颜色线型随图层                   |
| `11`    | `11`     | 设置图层为 "01"，颜色线型随图层                  |
| `22`    | `22`     | 设置图层为 "02"，颜色线型随图层                  |
| `33`    | `33`     | 设置图层为 "03"，颜色线型随图层                  |
| `44`    | `44`     | 设置图层为 "04"，颜色线型随图层                  |
| `55`    | `55`     | 设置图层为 "05"，颜色线型随图层                  |
| `66`    | `66`     | 设置图层为 "06"，颜色线型随图层                  |
| `77`    | `77`     | 设置图层为 "07"，颜色线型随图层                  |
| `88`    | `88`     | 设置图层为 "08"，颜色线型随图层                  |

------

## 🔧 内部工具函数（`(defun xxx)`，仅供代码内部调用）

| 函数名   | 功能说明                                 |
| -------- | ---------------------------------------- |
| `disxy`  | 返回一个点沿 X、Y 偏移后的新坐标         |
| `tg`     | 返回 tan(x)（即 sin(x)/cos(x)）          |
| `dxy`    | 对点对象进行平移，结果直接写回（副作用） |
| `rddatf` | 从指定文件中读取“首列匹配某值”的行并返回 |
| `getla`  | 获取当前图层名称                         |
| `setla`  | 设置当前工作图层为指定图层名             |
| `chp`    | 修改选中对象的颜色、图层、线型           |
| `mstyle` | 设置当前文字样式（字体名、高度、宽度）   |





## 4，支持迁移的代码

常用工具条的最后两个

以及符号工具条理带有jys文件夹的部分



一部分是我们自己开发的 `.lsp` 脚本（在 `jys2-2014` 下），这部分我**完全可以迁移到中望CAD**。

另一部分是“探索者”工具栏对应的功能，这些功能是**探索者软件公司封装的商业模块**，我**无法访问其源码**，也**无法迁移适配中望CAD**。 除非探索者官方发布支持中望CAD的版本（ZRX插件），否则这部分功能确实做不到迁移**。





# lsp脚本功能汇总

## 1，常用工具条

ID_E__HXW_LSP_TABT2_0 [_Button("常用表格", "RCDA9358.BMP", "RCDATA_16_SAVE")]^C^C(LOAD"D:/JYS2/TAB/TABT2") 
               [--]
ID_E__HXW_LSP_MEM_0 [_Button("数据处理", "RCDA6962.BMP", "RCDATA_16_ETRANSMIT")]^C^C(LOAD"d:/jys2/tab/MEM") 



### 1 D:/JYS2/TAB/TABT2---常用表格

#### 📌 功能概述

- 显示表格缩略图（`tabt2.sld`）
- 用户点击选择表格样式（3×3栅格）
- 插入对应的表格块（`btt11.dwg` 等）
- 特殊样式（如 `11`）支持动态绘线（按行数）

### 2， d:/jys2/tab/MEM---数据处理

#### 🧩 功能概述

该函数是一个`图形化的构件选择器，`主要功能为：

- 在 CAD 视图中加载一个 `.sld` 滑图（缩略图界面）
- 用户点击缩略图中的某一区域
- 程序识别点击位置并计算“区域编号”
- 根据编号加载对应的绘图功能脚本（如 `mater0.lsp`, `total.lsp` 等）

类似于一个“功能入口菜单”或“图形选单界面”。





### 2，符号工具条

| 序号 | 按钮名称     | 加载的 LISP 文件路径     | 功能描述                                                     | 依赖的外部代码                                               |
| ---- | ------------ | ------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1    | 立面标高     | D:/jys2-2014/ELVTA.lsp   | 在剖面图中点击线段自动计算并标注**`立面标高`**值，含引线、斜线和标高文字 | 使用 `tszsc` 全局变量，依赖文字样式 TSSD_Rein                |
| 2    | 平面标高     | D:/jys2-2014/ELVTX.lsp   | 在平面图中点击点位自动绘制标高引线和文字，标注如 ±0.000、+3.300 等平面高程 | 依赖 tszsc 变量和字体 TSSD_Rein                              |
| 3    | 本图节点     | D:/jys2-2014/JD1.lsp     | 在图中点击位置，插入一个圆圈加编号的节点符号，仅用于图纸提示 | 依赖 tszsc 变量和文字样式 TSSD_Rein                          |
| 4    | 详图节点     | D:/jys2-2014/JD2.lsp     | 在图上画一个圆圈，圆圈上下可以写两行字，用来提醒“这个地方的细节画在别的图里”。 | 依赖 tszsc 变量和文字样式 TSSD_Rein                          |
| 5    | 索引节点     | D:/jys2-2014/JD3.lsp     | 在图中画线并画一个圆圈，圈上下写字，表示“这个位置和另一张图有关 | 依赖 tszsc 变量、文字样式 TSSD_Rein，加载 `bsf.lsp`（这里就一个dtr  转弧度的） |
| 6    | 改变线宽     | D:/jys2-2014/CHWIDTH.lsp | 输入一个宽度，批量修改线段、圆和折线的宽度，圆用甜甜圈替代模拟宽边效果 | 依赖 tszsc 变量，用于缩放                                    |
| 7    | 切角         | D:/jys2-2014/QJ.lsp      | 在角落点上画一条短线表示“切角”，用于表示局部剖掉或转角裁剪的提示符号 | 依赖 tszsc 变量，使用 dxy 函数                               |
| 8    | 横剖切       | D:/jys2-2014/PM3.lsp     | 在图中点两点画出一条剖切符号线，并自动添加剖面编号文字，用来表示“从这里剖开，详图在其他图纸中 | 依赖 tszsc 变量，文字样式 TSSD_Rein                          |
| 9    | 竖剖切       | D:/jys2-2014/PM4.lsp     | 点两点画出上下箭头线和剖面编号文字，表示“从此竖向剖开，详图见其他图纸” | tszsc 变量，文字样式 TSSD_Rein                               |
| 10   | 剖面号       | D:/jys2-2014/PMFH.lsp    | **`不画剖面线`**，只是在已有剖面线上插入剖面线两端编号，如“A-A”，常与横剖或竖剖搭配使用 | tszsc 变量，TSSD_Rein 文字样式                               |
| 11   | 零件号       | D:/jys2-2014/NUM1.lsp    | 点出一条折线路径后，在终点处画一个编号圆圈，并输入零件编号，如 Z12、B01 等。用于构件编号 | tszsc 变量，TSSD_Rein 文字样式                               |
| 12   | 轴线号       | D:/jys2-2014/AXISA.lsp   | 在你点选的直线（轴线）**末端自动偏移插入圆圈 + 编号**，用于表示轴线代号（如 A、1、B）。 | tszsc 变量，TSSD_Rein 文字样式                               |
| 13   | 带方向轴线号 | D:/jys2-2014/AXISJ.lsp   | 在轴线两端插入圆圈，中心写轴线编号，另一端加带箭头标记方向。用于表达轴线起止方向 | tszsc 变量、TSSD_Rein 字体样式                               |
| 14   | 两点构件     | D:/jys2-2014/MEMBER2.lsp | 用户依次点击两点，自动在两点之间**缩进固定距离**后画一条带宽度的线段（如钢梁）。缩进长度默认150mm，通过比例换算后作用于图纸中，常用于表示构件不封顶或留边。 | `tszsc` 全局比例变量                                         |
| 15   | 设备基础螺栓 | D:/jys2-2014/ANCHOR1.lsp | 通过加载一个**幻灯片图例界面（`vslide`）**，你点击不同的小图位置，程序会根据你的**点击坐标**计算出一个编号 `joty`，然后在插入点用代码画出该编号对应的螺栓图形（圆、弧、pline 等组成的图案）——**所有图形都是现画的，不依赖外部块文件**。 | tszsc 全局变量、vslide 图示幻灯片                            |
| 16   | 统一字体     | D:/JYS2/zcm.lsp          | 遍历当前图纸中的所有文字样式（单行和多行文字），将其字体替换为指定的标准字体（如仿宋、tssdeng），统一图纸排版。支持清除大括号与无效字体信息，自动调用 `-style` 命令批量替换 | 无外部依赖；通过 AutoLISP 内部处理文本样式                   |
| 17   | 圆剖切面     | D:/jys2-2014/QMX.lsp     | 选择两点，在其中间自动绘制交叉圆弧剖切标志                   | 无外部依赖                                                   |
| 18   | 加箭头       | D:/jys2-2014/JT.lsp      | 给选中的线一端添加箭头（三角形填充）                         | 依赖 `tszsc` 全局变量（比例）                                |
| 19   | 引出斜线     | D:/jys2-2014/TT.lsp      | 点击图中某个点后自动生成一条**固定角度粗斜线**，用于视觉强调或引出说明 | 依赖 `tszsc` 全局变量（比例）                                |
| 20   | 文字统一修改 | D:/jys2-2014/CHTEXT.lsp  | 批量选中文字对象，并逐个提示用户输入新文字进行修改           | 无                                                           |





